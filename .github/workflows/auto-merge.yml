name: Auto Merge PR

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["Tests"]
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
    - name: Get PR number
      id: pr
      uses: actions/github-script@v7
      with:
        script: |
          let prNumber = null;
          
          // Try to get PR number from different event types
          if (context.payload.pull_request) {
            prNumber = context.payload.pull_request.number;
          } else if (context.payload.check_suite?.pull_requests?.[0]) {
            prNumber = context.payload.check_suite.pull_requests[0].number;
          } else if (context.payload.workflow_run?.pull_requests?.[0]) {
            prNumber = context.payload.workflow_run.pull_requests[0].number;
          }
          
          console.log(`PR number: ${prNumber}`);
          core.setOutput('number', prNumber);
          return prNumber;

    - name: Check if PR is approved and tests passed
      if: steps.pr.outputs.number != 'null' && steps.pr.outputs.number != ''
      id: check
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ steps.pr.outputs.number }};
          
          if (!prNumber) {
            console.log('No pull request found');
            return false;
          }
          
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          // Check if PR is approved (only considering latest review from each reviewer)
          const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          // Group reviews by user and get the latest review from each
          const latestReviewsByUser = reviews.reduce((acc, review) => {
            const userId = review.user.id;
            if (!acc[userId] || new Date(review.submitted_at) > new Date(acc[userId].submitted_at)) {
              acc[userId] = review;
            }
            return acc;
          }, {});
          
          const latestReviews = Object.values(latestReviewsByUser);
          const isApproved = latestReviews.some(review => review.state === 'APPROVED');
          const hasChangesRequested = latestReviews.some(review => review.state === 'CHANGES_REQUESTED');
          
          console.log(`PR #${prNumber} is approved: ${isApproved}`);
          console.log(`PR #${prNumber} has changes requested: ${hasChangesRequested}`);
          
          // Check if all checks have passed
          const { data: checkRuns } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pullRequest.head.sha
          });
          
          const allChecksPassed = checkRuns.check_runs.length === 0 || 
            checkRuns.check_runs.every(run => run.status === 'completed' && run.conclusion === 'success');
          
          console.log(`All checks passed: ${allChecksPassed} (${checkRuns.check_runs.length} checks)`);
          
          // Check commit statuses (for workflows that use statuses instead of checks)
          const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: pullRequest.head.sha
          });
          
          const allStatusesPassed = statuses.state === 'success' || statuses.statuses.length === 0;
          
          console.log(`All statuses passed: ${allStatusesPassed} (state: ${statuses.state}, ${statuses.statuses.length} statuses)`);
          
          const shouldMerge = isApproved && !hasChangesRequested && allChecksPassed && allStatusesPassed;
          
          console.log(`Should merge: ${shouldMerge}`);
          
          return shouldMerge;

    - name: Auto merge PR
      if: steps.check.outputs.result == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ steps.pr.outputs.number }};
          
          if (!prNumber) {
            console.log('No pull request number found');
            return;
          }
          
          try {
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash',
              commit_title: `Auto-merge: PR #${prNumber}`,
              commit_message: 'Automatically merged after approval and successful tests'
            });
            console.log(`Successfully merged PR #${prNumber}`);
          } catch (error) {
            console.log(`Failed to merge PR #${prNumber}: ${error.message}`);
            throw error;
          }
